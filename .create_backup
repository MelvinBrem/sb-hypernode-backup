#!/usr/bin/env zsh

COLOR_DEFAULT_TEXT="\033[0;39m"
COLOR_RED="\033[0;91m"
COLOR_WARNING="\033[0;93m"
COLOR_BLUE="\033[0;96m"

VAR_DATETIME="$(date +%Y-%m-%d_%H-%M)"
VAR_BACKUPDIR="./backups/backup_${VAR_DATETIME}"

cd ~

if [ ! -e './scripts/.env_config' ]; then
    printf "${COLOR_RED}No .env_config file found${COLOR_DEFAULT_TEXT}\n"
    exit
else
    . ./scripts/.env_config
fi

if [ -z "${ENV_DBNAME}" ]; then
    printf "${COLOR_RED}No ENV_DBNAME value set in .env_config${COLOR_DEFAULT_TEXT}\n"
    exit
fi

if [ ! -d './backups' ]; then
    mkdir backups
fi

mkdir ${VAR_BACKUPDIR}

printf "Creating backup of files...\n"

zip -r ${VAR_BACKUPDIR}/backup_files_${VAR_DATETIME}.zip ./public 2>&1 | pv -lep -s $(ls -Rl1  ./public | egrep -c '^[-/]') > /dev/null

printf "Creating backup of database...\n"

mysqldump --single-transaction ${ENV_DBNAME} > ${VAR_BACKUPDIR}/backup_database_${VAR_DATETIME}.sql

printf "=== Done ===\n"#!/usr/bin/env zsh
# Blame melvinbrem@socialbrothers.nl if this destroys something